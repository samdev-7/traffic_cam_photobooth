<html>
  <head>
    <title>Find your nearest camera</title>
    <link rel="stylesheet" href="styles.css"></style>
    <script src="./client_lists/atl_client.js"></script>
    <script src="./client_lists/md_client.js"></script>
    <script src="./client_lists/mn_client.js"></script>
    <script src="./client_lists/nyc_client.js"></script>
    <!-- <script src="./client_lists/sea_client.js"></script> -->
    <!-- <script src="./client_lists/nv_client.js"></script> -->
    <script src="./client_lists/ott_client.js"></script>
    <meta charset="UTF-8">
    <script>
        let allAreas = [nyc_cameras, atl_cameras, mn_cameras, md_cameras, ott_cameras]

        // let filtered_atl = atl_cameras.filter(cam => cam.id === "120992--2")
        // console.log("this is filtered atl", filtered_atl)
        console.log("hiiiii")
        // let allCameras = nyc_cameras.concat(atl_cameras, sea_cameras)
        let allCameras = []
        // console.log(allCameras.length)

        const getRelativeDistance = (userCoords, cameraCoords) => {
            // console.log("IM RUNINNG")
            // userCoords.latitude = 47
            // userCoords.longitude = -122.7488
            return Math.pow((Math.abs(userCoords.latitude) - Math.abs(cameraCoords.latitude)), 2) + Math.pow((Math.abs(userCoords.longitude) - Math.abs(cameraCoords.longitude)), 2)
        }
        let currentCamera = 0
        let closestCameras = []

        const updateAllInfo = (nearestCamera) => {
            console.log(nearestCamera, nearestCamera.imageUrl)
            // let urlToUseAndPass = nearestCamera.imageUrl
            let urlToUseAndPass = nearestCamera.imageUrl.indexOf("nyctmc") > -1 ? nearestCamera.imageUrl : `api${nearestCamera.imageUrl}`
            document.getElementById("cameraName").innerHTML = nearestCamera.name
            document.getElementById("cameraImage").src = `${urlToUseAndPass}?cacheAvoidance=${Math.floor(Math.random() * 100000)}`
            document.getElementById("cameraLink").href = `./interstitial.html?cameraId=${nearestCamera.id}&cameraUrl=${encodeURIComponent(urlToUseAndPass)}`
            document.getElementById("mapsLink").href = `https://www.google.com/maps/search/?api=1&query=${nearestCamera.latitude}%2C${nearestCamera.longitude}`
            document.getElementById("result").style.display = "block"
        }


        const findNearestCamera = (userCoords) => {
            document.getElementById('mainHeaderText').innerHTML = "Searching... one sec :)"
            console.log("in nearest camera")

            //sort all areas just by which one is closest to user based on first element
            //this allows us to only sort stuff near people without having them click where they are
            allAreas.sort((areaA, areaB) => {
                return getRelativeDistance(userCoords, areaA[0]) - getRelativeDistance(userCoords, areaB[0])
            })

            allCameras = allAreas[0]

            allCameras.filter(camera => {Math.abs(camera.latitude - userCoords.latitude) < 0.2 && Math.abs(camera.longitude - userCoords.longitude) < 0.2})
            allCameras.sort((cameraA, cameraB) => {
                return getRelativeDistance(userCoords, cameraA) - getRelativeDistance(userCoords, cameraB)
            })
            console.log("past sort")
            closestCameras = allCameras

        // onlyOnlineCameras = allCameras.filter((cam) => cam.isOnline)
        // closestCameras = onlyOnlineCameras.map(cam => { 
            // return {"camera" : cam, relativeDistance : 1000 }
            // })
            console.log("past map, closest cam[0]:", closestCameras[currentCamera])
            document.getElementById("buttonAsk").style.display = "none"
            // updateAllInfo({"camera" : closestCameras[currentCamera], relativeDistance : 1000 })
            updateAllInfo(closestCameras[currentCamera])
        }
        // const findNearestCamera = (userCoords) => {
        //     //probs not best practice
        //     let nearestCamera = {camera : {}, relativeDistance : 100000}

        //     allCameras.forEach(camera => {
        //         let dist = getRelativeDistance(userCoords, camera)
        //         if (dist < nearestCamera.relativeDistance) {
        //             console.log("new nearest camera:", camera)
        //             nearestCamera = {camera, relativeDistance : dist}
        //         }
        //     })
        //     console.log("final nearest camera:", nearestCamera)
        //     closestCameras.push(nearestCamera)
        //     updateAllInfo(closestCameras[0])
        // }

        const getUserLocation = () => {
            console.log("in get user location")
            document.getElementById("button").innerHTML = ''
            document.getElementById("button").style.background = `url('./loadingGifEf.gif'), #efefef`
            document.getElementById("button").style.backgroundPosition = `center`
            document.getElementById("button").style.backgroundRepeat = `no-repeat`
            navigator.geolocation.getCurrentPosition((position) => {

                    //clear the button
                    

                    // background: url('./loadingGif.gif');
            // background-position: center;
            // background-repeat: no-repeat
                    //do the actual stuff
                    console.log(position.coords.latitude, position.coords.longitude);
                    let userCoords = {}
                    userCoords.latitude = position.coords.latitude
                    userCoords.longitude = position.coords.longitude

                    findNearestCamera(userCoords)
            },(error) => {
                document.getElementById("buttonAsk").style.display = 'none'
                document.getElementById("result").style.display = 'none'
                document.getElementById("errorDiv").style.display = 'block'
                //maybe I should add a big ol list here lmao
                // alert("Geolocation Error\nYou probably have location turned off for your browser (a reasonable thing to do). Here are your options:\n(1) Turn on location in Settings > Location > [Your Browser]\n(2) Find a QR sticker near one in the wild and scan it (3) Close this popup and check out The Big List", error);
            },
            { timeout: 10000, maximumAge: 60000 }
            );
        }
        

        const refreshImage = () => {
            console.log("refresh cam", closestCameras[currentCamera])
            updateAllInfo(closestCameras[currentCamera])
        }

        const getNextClosestCamera = () => {
            currentCamera++
            updateAllInfo(closestCameras[currentCamera])
        }
    </script>
    <style>
        #result {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        #buttonAsk {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #button {
            min-width: 50vw;
            height: 10vh;
            background-color: #efefef;
            padding : 20px;
            font-size: 3em;
            padding: 10px;
            border-radius: 20px;
        }
/*             background: url('./loadingGif.gif');
            background-position: center;
            background-repeat: no-repeat; */
        #buttonDiv {
            min-width: 0vw;
            min-height: 10vh;
            font-size:xx-large;
            border-radius: 20px;
            background-color: grey;
        }

        img {
            width: 100%;
            max-height: 40vh;
        }
        #errorDiv {
            display: none;
            text-align: left;
            padding: 5vw
        }
    </style>
  </head>
  <body>
    <div class="main" id="main">
        <div id="buttonAsk">
            <h1 id="mainHeaderText">Click the button to find your nearest camera!</h1>
            <button id="button" onclick="getUserLocation()">üßêüîéüì∏</button>
            <!-- <div id="buttonDiv" onclick="getUserLocation()">üßêüîéüì∏</div> -->
        </div>
        <div id="result">
            <h1>Your nearest camera is "<span id="cameraName"></span>"</h1>
            <img id="cameraImage" src="./holderLoading.gif">
            <br/>
            <h2><a href="#" onclick='refreshImage()' id="refreshLink">Refresh Image</a><br/><span style="font-size: small;">(most update every 2s)</span></h2>
            <h2><a href="#" onclick='getNextClosestCamera()' id="nextClosestCameraLink">Next Closest Camera</a><br/><span style="font-size: small;">(refresh to go back to beginning)</span></h2>
            <h2><a href='' id="mapsLink">Find in Google Maps</a><br/><span style="font-size: small;">(close but not always super accurate,<br/>trust the street names more)</span></h2>
            <h2><a href="" id="cameraLink">I'm ready!</a></h2>
        </div>
        <div id="errorDiv">
            <h1>Geolocation Error</h1>
            <p>You probably have location services turned off on your phone, or don't want to share your location (reasonable tbh). To use the site without GPS, you have two options:</p>
            <ul>
                <li>Find a camera manually by going to the <a href="./map.html">Map</a> or the <a href="./listPage.html">List Page</a></li>
                <li>Turn on location in Settings > Location > [Your Browser] and reload this page</li>
            </ul>
        </div>
    </div>
  </body>
</html>