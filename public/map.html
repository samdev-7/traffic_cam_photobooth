<html>
  <head>
    <title>Map of all NYC cameras</title>
    <meta charset="UTF-8">
    <!-- <script src="https://cdn.jsdelivr.net/npm/p5@1.9.4/lib/p5.js"></script> -->
    <link rel="stylesheet" href="styles.css"></style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
     <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
    <script src="./client_lists/atl_client.js"></script>
    <script src="./client_lists/md_client.js"></script>
    <script src="./client_lists/mn_client.js"></script>
    <script src="./client_lists/nyc_client.js"></script>
    <!-- <script src="./client_lists/sea_client.js"></script> -->
    <script src="./client_lists/ott_client.js"></script>
    <script>
        let allCameras = [...nyc_cameras, ...atl_cameras, ...mn_cameras, ...md_cameras, ...ott_cameras]


        const queryString = window.location.search;
        console.log(queryString);
        const urlParams = new URLSearchParams(queryString);
        let onDesktop = urlParams.get('onDesktop')
        console.log("onDesktop value", onDesktop)

        const getUserLocation = () => {
            document.getElementById("button").innerHTML = ''
            document.getElementById("button").style.background = `url('./loadingGifEf.gif'), #efefef`
            document.getElementById("button").style.backgroundPosition = `center`
            document.getElementById("button").style.backgroundRepeat = `no-repeat`
            navigator.geolocation.getCurrentPosition((position) => {

                    //clear the button
                    

                    // background: url('./loadingGif.gif');
            // background-position: center;
            // background-repeat: no-repeat
                    //do the actual stuff
                    console.log(position.coords.latitude, position.coords.longitude);
                    let userCoords = {}
                    userCoords.latitude = position.coords.latitude
                    userCoords.longitude = position.coords.longitude

                    findNearestCamera(userCoords)
            },(error) => {
                document.getElementById("buttonAsk").style.display = 'none'
                document.getElementById("result").style.display = 'none'
                document.getElementById("errorDiv").style.display = 'block'
                //maybe I should add a big ol list here lmao
                // alert("Geolocation Error\nYou probably have location turned off for your browser (a reasonable thing to do). Here are your options:\n(1) Turn on location in Settings > Location > [Your Browser]\n(2) Find a QR sticker near one in the wild and scan it (3) Close this popup and check out The Big List", error);
            },
            { timeout: 10000, maximumAge: 60000 }
            );
        }
    </script>
    <style>
        #map { 
            height: 100vh; 
            width: 100vw}
        
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
        var map = L.map('map').setView([40.75569, -73.8639], 12);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        var myIcon = L.icon({
            iconUrl: 'cameraIcon.png',
            // iconSize: [38, 95],
            iconAnchor: [22, 94],
            popupAnchor: [-3, -76],
            // shadowUrl: 'my-icon-shadow.png',
            // shadowSize: [68, 95],
            // shadowAnchor: [22, 94]
        });
        class CameraLocation {
            constructor(lat, long, name, id, imageUrl) {
                this.lat = lat;
                this.long = long;
                this.name = name;
                this.id = id;
                this.imageUrl = imageUrl;
                this.marker = L.marker([this.lat, this.long], {icon : myIcon})
                    .bindPopup(`<h2>Camera Name:<br/>${this.name}</h2>
                    <img style="max-width: 100%" id='${this.name}' src='${this.imageUrl.indexOf("nyctmc") > -1 ? this.imageUrl : "/api" + this.imageUrl}'> 
                    ${onDesktop === 'yes' ? '' : "<h2><a href='./interstitial.html?cameraId=" + this.id + "&cameraUrl=" + this.imageUrl + "'>Take Picture Here</a></h2>"}
                    <h2><a href='https://www.google.com/maps/search/?api=1&query=${this.lat}%2C${this.long}'>Find in Google Maps (not always super accurate)</a></h2>
                    <!-- <h2><a href='#' onclick='() => {document.getElementById("${this.name}").src="${this.imageUrl}?cacheAvoidance=${this.cacheAvoidanceNum()}"}'>Refresh Image</a></h2>
                    // <button id='button_${this.id}' onclick='updateImage(${this.name})'>Refresh Image</button> -->`).addTo(map)
            }
            cacheAvoidanceNum = () => {
                console.log("in achaec avoideance")
                return Math.floor(Math.random() * 100000)
            }
        }

        // THE PROBLEM HERE IS PROBABLY JUST THE DASHES IN THE ID STRING
        const updateImage = (imageDivId) => {
            console.log("hiiii in upateImage")
            // document.getElementById(imageDivId).src = `https://webcams.nyctmc.org/api/cameras/${imageDivId}/image?cacheAvoidance=${Math.floor(Math.random() * 100000)}`
        } 
        allCameras.forEach(camera => {
            let newCamera = new CameraLocation(camera.latitude, camera.longitude, camera.name, camera.id, camera.imageUrl)
        })
    </script>
  </body>
</html>